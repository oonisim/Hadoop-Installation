#--------------------------------------------------------------------------------
# Install Packages
#--------------------------------------------------------------------------------
- include_vars: "{{ ansible_distribution }}_{{ ansible_distribution_major_version}}.yml"
- include_tasks: "{{ ansible_distribution }}_{{ ansible_distribution_major_version}}.yml"

- name: "Create/recreate {{ SPARK_DOWNLOAD_DIR }}"
  file:
    path:   "{{ SPARK_DOWNLOAD_DIR }}"
    state:  "directory"
    owner:  "{{ SPARK_ADMIN }}"
    group:  "{{ SPARK_GROUP }}"
    mode:   0770

- name: "Set owner/group as {{ SPARK_ADMIN }}:{{ SPARK_GROUP }} recursively {{ SPARK_HOME }}"
  file:
    path:   "{{ SPARK_HOME }}"
    state:  "directory"
    owner:  "{{ SPARK_ADMIN }}"
    group:  "{{ SPARK_GROUP }}"
    recurse: true

- name: "Download {{ SPARK_DOWNLOAD_URL }}"
  get_url:
    url:   "{{ SPARK_DOWNLOAD_URL }}"
    dest:  "{{ SPARK_DOWNLOAD_DIR }}/{{ SPARK_PACKAGE }}"
    owner: "{{ SPARK_ADMIN }}"
    group: "{{ SPARK_GROUP }}"
    mode:  0770
    checksum: "{{ SPARK_PACKAGE_CHECKSUM }}"

- name: "Install {{ SPARK_PACKAGE }}"
  shell: |
    tar --overwrite --owner={{ SPARK_ADMIN }} --group={{ SPARK_GROUP }} -xzvf {{ SPARK_PACKAGE }} -C {{ SPARK_HOME }} --strip-components=1
  args:
    chdir: "{{ SPARK_DOWNLOAD_DIR }}"

- name: "Copy configuration files"
  template:
    src   : "{{ item }}"
    dest  : "{{ SPARK_HOME }}/conf/{{ item | basename | regex_replace('\\.j2','') }}"
    owner : "{{ SPARK_ADMIN }}"
    group : "{{ SPARK_GROUP }}"
    mode  : 0664
    backup: yes
  with_fileglob:
    - "{{ role_path }}/templates/conf/*"

- name: "Copy pofile.d files"
  template:
    src   : "{{ item }}"
    dest  : "/etc/profile.d/{{ item | basename | regex_replace('\\.j2','') }}"
    owner : "{{ SPARK_ADMIN }}"
    group : "{{ SPARK_GROUP }}"
    mode  : 0664
    backup: yes
  with_fileglob:
    - "{{ role_path }}/templates/profile.d/*"